<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>事務所統合プロジェクト アンケート分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 450px; 
            max-height: 60vh;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 500px;
                max-height: 70vh;
            }
        }
        /* テキストエリアのフォーカスリングを少し目立たせる */
        textarea:focus {
            ring-2 ring-blue-500 border-blue-500;
        }
    </style>
</head>
<body class="text-[#00124F]">

    <!-- ★ヘッダー (Firebase連携を再追加) -->
    <header class="bg-[#003E7A] text-white p-6 shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-bold">事務所統合プロジェクト アンケート分析と対策</h1>
            <!-- Firebase 接続ステータスとユーザーID -->
            <div class="text-right">
                <div id="auth-status" class="text-sm text-yellow-300">接続中...</div>
                <div id="user-id-display" class="text-xs text-gray-300 font-mono" title="あなたのユーザーID"></div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="max-w-7xl mx-auto p-4 md:p-8">

        <!-- ★導入セクション (Firebase連携の案内を再追加) -->
        <section id="intro" class="mb-10">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-[#003E7A] mb-3">プロジェクト概要とアンケートの目的</h2>
                <p class="text-base leading-relaxed">
                    プロジェクトへのご協力ありがとうございます。計8件の貴重なご意見をいただきました。
                    このインフォグラフィックは皆様から寄せられたフィードバックを可視化し、現状の課題と対策案を共有するものです。
                </p>
                <p id="intro-text-firebase" class="text-base leading-relaxed mt-2 font-semibold text-blue-800">
                    データベースに接続中です...（注：入力内容は保存されません）
                </p>
            </div>
        </section>

        
        <!-- 全体評価グラフと総評 -->
        <section id="overview" class="mb-12">
            <h2 class="text-3xl font-bold text-[#003E7A] mb-6 text-center">全体評価（スコア概要）</h2>
            <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
                <!-- グラフコンテナ -->
                <div class="chart-container">
                    <canvas id="overallScoresChart"></canvas>
                </div>
                
                <!-- 総評と主要課題のハイライト -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h3 class="text-xl font-bold text-[#003E7A] mb-4">総評と主要課題</h3>

                    <!-- キー課題のハイライトカード -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
                        <!-- 課題 1: 低評価 -->
                        <div class="bg-red-50 border border-red-200 p-4 rounded-lg shadow-sm">
                            <div class="flex items-center mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                                </svg>
                                <h4 class="font-bold text-red-700">低評価項目 (平均 3.0点)</h4>
                            </div>
                            <p class="text-sm text-red-900">「休憩スペース」「倉庫スペース」「休憩室の機能変化」は改善が必要です。</p>
                        </div>
                        <!-- 課題 2: 共通課題 -->
                        <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg shadow-sm">
                            <div class="flex items-center mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <h4 class="font-bold text-orange-700">共通の課題</h4>
                            </div>
                            <p class="text-sm text-orange-900">「靴箱・アウター掛け」の配置と導線の見直しが複数指摘されています。</p>
                        </div>
                        <!-- 課題 3: 高評価 -->
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg shadow-sm">
                            <div class="flex items-center mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 19H6a2 2 0 01-2-2V7a2 2 0 012-2h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 00.707.293H14z" />
                                </svg>
                                <h4 class="font-bold text-blue-700">高評価項目 (平均 3.63点)</h4>
                            </div>
                            <p class="text-sm text-blue-900">「OPルーム」「発送スペース」など執務エリアは比較的高評価です。</p>
                        </div>
                    </div>
                    
                    <!-- 元の総評テキスト -->
                    <p class="text-base leading-relaxed text-gray-800">
                        上記サマリーの通り、OPルームや発送スペースなど執務エリアは比較的高評価です。
                        一方、「休憩スペース」「倉庫スペース」「休憩室の機能変化」の3項目が平均3.0点と低く、改善が必要です。
                        特に「靴箱・アウター掛け」の配置に関するご意見が複数あり、導線の見直しが共通の課題となっています。
                    </p>
                </div>
            </div>
        </section>


        
        <!-- 全フィードバックセクション -->
        <section id="all-feedback" class="mb-10">
            <h2 class="text-3xl font-bold text-[#003E7A] mb-6 text-center">アンケート項目別の全ご意見と対策案</h2>
            
            
            <!-- セクション① -->
            <div class="bg-blue-50 rounded-lg shadow-lg p-6 mb-6">
                <!-- ヘッダー -->
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 pb-4 border-b">
                    <div class="flex items-center mb-3 md:mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h10a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.7 9.3l.16-.295A2 2 0 0110.154 8h3.692a2 2 0 011.753 1.005l.16.294M7 11h10M7.386 16.671L7.177 17.22a2 2 0 001.789 2.78h8.068a2 2 0 001.79-2.78l-.21-1.228" />
                        </svg>
                        <h3 class="text-2xl font-bold text-[#003E7A]">① オペレーションルーム【日勤】</h3>
                    </div>
                    <div class="text-left md:text-right">
                        <span class="text-sm font-semibold text-gray-600">平均スコア</span>
                        <p class="text-4xl font-bold text-blue-600">3.63</p>
                    </div>
                </div>
                <!-- コンテンツ -->
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「ロッカー近くのテーブルは用途が不明なので不要かと思います」</p>
                        <textarea id="q1_1" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="3" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「可能であれば 各座席同じ方向ではなく互い違いにしていただきたい」</p>
                        <textarea id="q1_2" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="2" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「アウター掛けと靴箱は元の入り口横に配置が良いと思います。出勤時・退勤時の導線が不便なので」</p>
                        <textarea id="q1_3" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="2" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                </div>
            </div>

            <!-- セクション② -->
            <div class="bg-gray-50 rounded-lg shadow-lg p-6 mb-6">
                <!-- ヘッダー -->
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 pb-4 border-b">
                    <div class="flex items-center mb-3 md:mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                        <h3 class="text-2xl font-bold text-[#003E7A]">② オペレーションルーム【夜勤】</h3>
                    </div>
                    <div class="text-left md:text-right">
                        <span class="text-sm font-semibold text-gray-600">平均スコア</span>
                        <p class="text-4xl font-bold text-blue-600">3.63</p>
                    </div>
                </div>
                <!-- コンテンツ -->
                <div class="space-y-4">
                    <p class="text-gray-700 p-4 bg-white rounded-lg shadow-sm">具体的なご意見はありませんでした（「不明」「特になし」のみ）。</p>
                </div>
            </div>
            
            <!-- セクション③ -->
            <div class="bg-green-50 rounded-lg shadow-lg p-6 mb-6">
                <!-- ヘッダー -->
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 pb-4 border-b">
                    <div class="flex items-center mb-3 md:mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2-2h8zM17 8h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1v-1a3 3 0 00-3-3H6m11 11v-1a3 3 0 00-3-3h-1" />
                        </svg>
                        <h3 class="text-2xl font-bold text-[#003E7A]">③ 発送作業スペース</h3>
                    </div>
                    <div class="text-left md:text-right">
                        <span class="text-sm font-semibold text-gray-600">平均スコア</span>
                        <p class="text-4xl font-bold text-blue-600">3.63</p>
                    </div>
                </div>
                <!-- コンテンツ -->
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「入口から手前左側のPCが置いていない側の２つの作業スペースですが...使用している感じでもない...設置しなくてもいい気がします」</p>
                        <textarea id="q3_1" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="3" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「主担当者（李）さんの作業スペースを倉庫の近くに配置しないと不便で非効率的...複合機の設置も同様」</p>
                        <textarea id="q3_2" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="4" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                </div>
            </div>

            <!-- セクション④ -->
            <div class="bg-yellow-50 rounded-lg shadow-lg p-6 mb-6">
                <!-- ヘッダー -->
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 pb-4 border-b">
                    <div class="flex items-center mb-3 md:mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="text-2xl font-bold text-[#003E7A]">④ 休憩スペース</h3>
                    </div>
                    <div class="text-left md:text-right">
                        <span class="text-sm font-semibold text-gray-600">平均スコア</span>
                        <p class="text-4xl font-bold text-red-600">3.00</p>
                    </div>
                </div>
                <!-- コンテンツ -->
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「元に戻した方がいいのでは？①エアコン...②窮屈...③近すぎて休めない...④気を遣う...」</p>
                        <textarea id="q4_1" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="4" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「机があり狭くて引っかかる。ゴミ箱が目の前にあり圧迫感がある。部屋が明るすぎて前の場所の方が落ち着ける。空調の調整が難しい」</p>
                        <textarea id="q4_2_a" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="2" placeholder="対策案（明るさ・空調）..."></textarea>
                        <textarea id="q4_2_b" class="w-full p-3 rounded-md mt-1 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="3" placeholder="対策案（圧迫感）..."></textarea>
                    </div>
                    <!-- 意見が重複しているため、1つに統合 -->
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「入口左手前側に作業スペースとして置かれている2つのテーブルを持っていくのはどうでしょうか？」</p>
                        <textarea id="q4_3" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="3" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「夜勤スタッフを増員した場合、スペースが不足すると思われるので増員前に確保が必要」</p>
                        <textarea id="q4_4" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="2" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「夜勤時においてですが、ウォーターサーバーは仮眠中の方がいる場合、入りづらいと思うので外に配置した方がいい」</p>
                        <textarea id="q4_5" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="3" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「テーブルは80～100㎝角のものを2台配置...ウォーターサーバーとゴミ箱はオペレーションスペースへ移動した方が良い...」</p>
                        <textarea id="q4_6" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="3" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- セクション⑤ -->
            <div class="bg-orange-50 rounded-lg shadow-lg p-6 mb-6">
                <!-- ヘッダー -->
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 pb-4 border-b">
                    <div class="flex items-center mb-3 md:mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        <h3 class="text-2xl font-bold text-[#003E7A]">⑤ 倉庫スペース</h3>
                    </div>
                    <div class="text-left md:text-right">
                        <span class="text-sm font-semibold text-gray-600">平均スコア</span>
                        <p class="text-4xl font-bold text-red-600">3.00</p>
                    </div>
                </div>
                <!-- コンテンツ -->
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「シューズボックス、傘たてなどは入口の近くがいいです」</p>
                        <textarea id="q5_1" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="2" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「倉庫スペースがもったいない。あまり出入りをしないため、靴箱・衣文かけは入り口付近に戻した方がよさそう。無印の荷物入れも奥だと取りづらいかもです」</p>
                        <textarea id="q5_2" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="2" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「カウンターテーブル不要です。封筒ダンボールが種別後に分類して、積み上げにくいです」</p>
                        <textarea id="q5_3" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="3" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                </div>
            </div>

            <!-- セクション⑥ -->
            <div class="bg-purple-50 rounded-lg shadow-lg p-6 mb-6">
                <!-- ヘッダー -->
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 pb-4 border-b">
                    <div class="flex items-center mb-3 md:mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        <h3 class="text-2xl font-bold text-[#003E7A]">⑥ その他 ご意見・ご要望</h3>
                    </div>
                </div>
                <!-- コンテンツ -->
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「休憩スペースは人の出入りが気になってゆっくり休めない...ロールカーテンを...」</p>
                        <textarea id="q6_1" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="3" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「休憩室の前の席だと、ドア付近で出入りに邪魔になるかもしれない」</p>
                        <textarea id="q6_2" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="2" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「アウター・傘掛けと私物ロッカーを入口のほうに置くのはいかがでしょうか？」</p>
                        <textarea id="q6_3" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="2" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「靴箱と傘立ては、雨で靴が濡れた状態で室内を歩くことを考えると出入り口付近のほうがいい」</p>
                        <textarea id="q6_4" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="2" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「...全体的に物が多すぎる...フリーアドレス的な視点...休憩室と倉庫の配置を交換した方が良い」</p>
                        <textarea id="q6_5" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="3" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800">ご意見:「今更ですが何かお手伝いできることがいつでもあれば声かけしてほしいです」</p>
                        <textarea id="q6_6" class="w-full p-3 rounded-md mt-2 bg-gray-50 border border-gray-200 text-gray-800 resize-none" rows="2" placeholder="対策案をこちらに入力..."></textarea>
                    </div>
                </div>
            </div>

        </section>

    </main>

    <!-- フッター -->
    <footer class="bg-[#00124F] text-white p-6 text-center">
        <p class="text-sm">© 事務所統合プロジェクトチーム</p>
    </footer>

    <!-- ★ グラフ描画スクリプト と Firebase連携スクリプト -->
    <script type="module">
        // Firebase SDK のインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOMが読み込まれたら、すべてのスクリプトを実行
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- UI Elements ---
            const authStatusEl = document.getElementById('auth-status');
            const userIdEl = document.getElementById('user-id-display');
            const introTextEl = document.getElementById('intro-text-firebase');
            
            // 対象となるすべてのテキストエリアのID
            const textareaIds = [
                'q1_1', 'q1_2', 'q1_3',
                'q3_1', 'q3_2',
                'q4_1', 'q4_2_a', 'q4_2_b', 'q4_3', 'q4_4', 'q4_5', 'q4_6',
                'q5_1', 'q5_2', 'q5_3',
                'q6_1', 'q6_2', 'q6_3', 'q6_4', 'q6_5', 'q6_6'
            ];
            // IDとDOM要素のマップを作成
            const textareas = new Map(textareaIds.map(id => [id, document.getElementById(id)]));
            
            // --- Firebase Vars ---
            let db, auth;
            let userId = null;
            let reportDocRef; // Firestore ドキュメントへの参照
            let unsubscribe = () => {}; // リアルタイムリスナーの停止用
            let debounceTimer; // 自動保存のデバウンス用

            // --- Config Vars (Canvas環境から提供される) ---
            const firebaseConfig = typeof __firebase_config !== 'undefined'
                ? JSON.parse(__firebase_config)
                : { apiKey: "FALLBACK_API_KEY", authDomain: "FALLBACK_AUTH_DOMAIN", projectId: "FALLBACK_PROJECT_ID" }; // 動作しないフォールバック
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            // Firestoreのパス設定 (公開データ用)
            const collectionPath = `/artifacts/${appId}/public/data/project-feedback`;
            const documentId = 'mainReport'; // このレポート専用の単一ドキュメント

            // --- 1. Firebase 初期化 ---
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // デバッグログをコンソールに出力
            } catch (e) {
                console.error("Firebase Init Error:", e);
                if (authStatusEl) authStatusEl.textContent = "初期化エラー";
                if (introTextEl) introTextEl.textContent = "エラー: データベースに接続できません。";
                return; // これ以上進まない
            }

            // --- 2. 認証ロジック ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // ユーザー認証済み
                    userId = user.uid;
                    if (userIdEl) userIdEl.textContent = `UserID: ${userId}`;
                    if (authStatusEl) authStatusEl.textContent = "認証済み";
                    if (introTextEl) introTextEl.textContent = "下のテキストエリアに「対策案」を直接入力してください。入力内容は自動で保存・共有されます。";

                    // 認証が成功したので、ドキュメントの参照を作成
                    reportDocRef = doc(db, collectionPath, documentId);
                    // データの読み込みとリアルタイム監視を開始
                    loadAndListenForAnswers();

                } else {
                    // ユーザー未認証
                    if (authStatusEl) authStatusEl.textContent = "認証中...";
                    try {
                        if (initialAuthToken) {
                            // 提供されたトークンでサインイン
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // トークンがない場合、匿名でサインイン
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth Error:", error);
                        if (authStatusEl) authStatusEl.textContent = "認証エラー";
                        if (introTextEl) introTextEl.textContent = "エラー: データベース認証に失敗しました。";
                    }
                }
            });

            // --- 3. Firestore データの読み込みと監視 ---
            function loadAndListenForAnswers() {
                if (!reportDocRef) return; // 参照がなければ何もしない
                if (authStatusEl) authStatusEl.textContent = "データ読み込み中...";

                unsubscribe(); // 既存の監視を停止
                unsubscribe = onSnapshot(reportDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // Firestore のデータで全テキストエリアを更新
                        textareas.forEach((textarea, id) => {
                            if (textarea && data[id] !== undefined) {
                                // 自分が入力中（フォーカス中）のエリアは、外部からの変更で上書きしない
                                if (document.activeElement !== textarea) {
                                    textarea.value = data[id];
                                }
                            }
                        });
                        if (authStatusEl) authStatusEl.textContent = "データ同期済み";
                    } else {
                        // ドキュメントがまだ存在しない（初回書き込み前）
                        if (authStatusEl) authStatusEl.textContent = "新規ドキュメント";
                    }
                }, (error) => {
                    console.error("Data Load Error:", error);
                    if (authStatusEl) authStatusEl.textContent = "同期エラー";
                });
            }

            // --- 4. Firestore へのデータ保存 ---
            async function saveAnswer(id, value) {
                if (!reportDocRef) return; // 認証が完了していない場合は保存しない

                if (authStatusEl) authStatusEl.textContent = "保存中...";
                try {
                    // setDoc に merge: true を指定し、ドキュメント全体を上書きせず、
                    // 特定のフィールド（[id]）だけを更新（または追加）する
                    await setDoc(reportDocRef, { [id]: value }, { merge: true });
                    
                    if (authStatusEl) authStatusEl.textContent = "保存済み";
                } catch (error) {
                    console.error("Save Error:", error);
                    if (authStatusEl) authStatusEl.textContent = "保存エラー";
                }
            }

            // --- 5. Textarea イベントリスナー設定 ---
            textareas.forEach((textarea, id) => {
                if (textarea) {
                    textarea.addEventListener('input', (e) => {
                        // 入力のたびに保存すると高負荷なため、入力をデバウンス（遅延）させる
                        clearTimeout(debounceTimer);
                        
                        const value = e.target.value;
                        if (authStatusEl) authStatusEl.textContent = "入力中...";

                        debounceTimer = setTimeout(() => {
                            saveAnswer(id, value);
                        }, 1000); // 最後の入力から1秒後に保存処理を実行
                    });
                }
            });

            // --- 6. グラフ描画ロジック (既存) ---
            const ctx = document.getElementById('overallScoresChart').getContext('2d');
            
            const labels = [
                'OPルーム(日勤)', 
                'OPルーム(夜勤)', 
                '発送作業スペース',
                '休憩スペース', 
                '倉庫スペース', 
                '入電体制の変化',
                '休憩室の機能変化', 
                '倉庫・発送の動線', 
                '運用ルールの効率性'
            ];
            
            const data = [
                3.625, // OP日勤
                3.625, // OP夜勤
                3.625, // 発送
                3.0,   // 休憩
                3.0,   // 倉庫
                3.25,  // 入電
                3.0,   // 休憩室機能
                3.125, // 倉庫動線
                3.5    // 運用
            ];
            
            const bgColors = data.map(score => {
                if (score <= 3.0) return '#E53E3E'; // 赤
                if (score < 3.5) return '#ED8936'; // オレンジ
                return '#3182CE'; // 青
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '平均評価',
                        data: data,
                        backgroundColor: bgColors,
                        borderColor: '#ffffff',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 5,
                            ticks: { color: '#00124F', font: { weight: 'bold' } },
                            grid: { color: '#e0e0e0' }
                        },
                        y: {
                            ticks: { color: '#00124F', font: { size: 14 } },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '各エリア・機能の平均評価 (5段階)',
                            font: { size: 18, weight: 'bold' },
                            color: '#003E7A',
                            padding: { bottom: 20 }
                        },
                        tooltip: {
                            backgroundColor: '#00124F',
                            titleFont: { size: 16 },
                            bodyFont: { size: 14 },
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    let label = item.chart.data.labels[item.dataIndex];
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
        }); // DOMContentLoaded 終了
    </script>
</body>
</html>

